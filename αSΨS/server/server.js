/* αdithep SriNarulα | 18-01-2014 */
var TEST,fs,path,removeman,stream;Accounts.validateNewUser(function(){return!0}),fs=Npm.require("fs"),path=Npm.require("path"),stream=Npm.require("stream"),TEST=new Meteor.Collection("test"),this.traverse=Meteor.require("traverse"),Meteor.methods({insert_human:function(a){var b,c,d;return d=DATA.findOne({name:"humans"}),b=DATA.findOne({name:"contact_button_list"}),c={},c.aggregate={},_.map(a,function(a){var d,e,f,g,h;g=new Meteor.Collection.ObjectID(a.id),f=DATA.findOne({_id:g,type:b._id},{fields:{input:1,parent_obj:1,parent_obj_t:1,array:1,input_type:1,individual:1}}),h=0,d||(d={}),e||(e={}),_.map(a.arr,function(b){var g,i,j,k;return"id"===f.input[h].value_type?(k=new Meteor.Collection.ObjectID(b.value),b.value=k,j=DATA.findOne({_id:k},{fields:{name:1}}),b.name=j.name):"date"===f.input[h].value_type?(b.value=new Date(b.value),b.name=b.value.toDateString()):"currency"===f.input[h].value_type?(b.name=parseFloat(b.value),b.value=100*parseFloat(b.value)):"phone"===f.input[h].value_type&&(b.name=formatInternational(countryForE164Number(b.value),b.value)),0===f.array?f.parent_obj?(c[f.parent_obj]||(c[f.parent_obj]={}),b.name&&!c.aggregate[f.parent_obj]&&(c.aggregate[f.parent_obj]={}),g={},g[b.key]=b.value,b.name&&(i={},i[b.key]=b.name),_.extend(c[f.parent_obj],g),b.name&&_.extend(c.aggregate[f.parent_obj],i)):(c[b.key]=b.value,b.name&&(c.aggregate[b.key]=b.name)):1===f.array&&(f.parent_obj_t?(c[f.parent_obj_t]||(c[f.parent_obj_t]={}),c[f.parent_obj_t][b.key]||(c[f.parent_obj_t][b.key]=[]),c[f.parent_obj_t][b.key].push(b.value),b.name&&(c.aggregate[f.parent_obj_t]||(c.aggregate[f.parent_obj_t]={}),c.aggregate[f.parent_obj_t][b.key]||(c.aggregate[f.parent_obj_t][b.key]=[]),c.aggregate[f.parent_obj_t][b.key].push(b.name))):f.parent_obj?(c[f.parent_obj]||(c[f.parent_obj]=[]),b.name&&!c.aggregate[f.parent_obj]&&(c.aggregate[f.parent_obj]=[]),d[b.key]=b.value,b.name&&(e[b.key]=b.name),a.arr.length===_.size(d)&&(c[f.parent_obj].push(d),_.isEmpty(e)||c.aggregate[f.parent_obj].push(e))):(c[b.key]||(c[b.key]=[]),c[b.key].push(b.value),b.name&&(c.aggregate[b.key]||(c.aggregate[b.key]=[]),c.aggregate[b.key].push(b.name)))),h++})}),c.type=d._id,console.log(c),console.log(c.aggregate)},input_select:function(a){var b,c;return a.input?(c=new Meteor.Collection.ObjectID(a.field),b=DATA.find({$and:[{type:c},{$or:[{name:{$regex:a.input,$options:"i"}},{country:{$regex:a.input,$options:"i"}}]}]},{limit:5,fields:{name:1,country:1}}).fetch(),_.map(b,function(a){return a.str=a._id._str,delete a._id}),b):void 0},city_by_id:function(a){var b,c;return a?(b=DATA.findOne({name:"city",type:"type"}),c=DATA.findOne({_id:a,type:b._id}),c.name):void 0},delete_human:function(a){var b,c;return a?(b=DATA.findOne({name:"humans"}),c=new Meteor.Collection.ObjectID(a),DATA.remove({_id:c,type:b._id})):void 0},save_contact_json:function(){var a,b,c;return a=DATA.findOne({name:"humans"}),b=DATA.find({type:a._id},{fields:{_id:0}}).fetch(),_.map(b,function(a){var b,c;a.type="humans",a.full_name.initials&&(c=DATA.findOne({_id:a.full_name.initials}),a.full_name.initials=c.name),a.city&&(b=DATA.findOne({_id:a.city}),a.city=b.name),a.service&&_.map(a.service,function(a){var b,c;a.service&&(c=DATA.findOne({_id:a.service}),a.service=c.name),a.currency&&(b=DATA.findOne({_id:a.currency}),a.currency=b.name)})}),c=path.join("/Users/Adithep/Desktop/αSys/json","contacts.json"),fs.writeFile(c,EJSON.stringify(b,{indent:!0}),function(a){if(a)throw a;return console.log("human.json written")})}}),Meteor.publish("type",function(){return DATA.find({type:"type"})}),Meteor.publish("list",function(){var a,b,c,d;return a=DATA.findOne({name:"contact_button_list",type:"type"}),b=DATA.findOne({name:"initials_list",type:"type"}),d=DATA.findOne({name:"service",type:"type"}),c=DATA.findOne({name:"reach_type",type:"type"}),DATA.find({$or:[{type:a._id},{type:b._id},{type:"type"},{type:d._id},{type:c._id}]})}),Meteor.publish("countries_list",function(){var a;return a=DATA.findOne({name:"countries_list",type:"type"}),DATA.find({type:a._id},{sort:{name:1},fields:{name:1,type:1,callingCode:1,cca2:1}})}),Meteor.publish("currency",function(){var a;return a=DATA.findOne({name:"currency",type:"type"}),DATA.find({type:a._id},{sort:{name:1},fields:{name:1,type:1,symbol:1,usd_exchange_rate:1,country:1,"default":1}})}),Meteor.publish("cities_list",function(a){var b;return a.input?(b=new Meteor.Collection.ObjectID(a.field),DATA.find({$and:[{type:b},{$or:[{name:{$regex:a.input,$options:"i"}},{country:{$regex:a.input,$options:"i"}}]}]},{limit:5,fields:{name:1,country:1,type:1}})):void 0}),Meteor.publish("city_by_id",function(a){var b;return a?(b=DATA.findOne({name:"city",type:"type"}),DATA.find({_id:a,type:b._id})):void 0}),Meteor.publish("human_city",function(){var a,b;return b=DATA.findOne({name:"humans",type:"type"}),a=DATA.distinct("city",b._id),DATA.find({type:b._id}),DATA.find({_id:{$in:a}})}),Meteor.publish("initials_list",function(){var a;return a=DATA.findOne({name:"initials_list",type:"type"}),a?DATA.find({type:a._id}):void 0}),Meteor.publish("humans",function(){var a,b;return b=DATA.findOne({name:"humans",type:"type"}),a=DATA.distinct("city",b._id),DATA.find({$or:[{_id:{$in:a}},{type:b._id}]})}),removeman=function(){var a,b;return a=DATA.findOne({name:"contact_button_list"}),b=DATA.findOne({name:"contact_input_list"}),a&&DATA.remove({type:a._id}),b?DATA.remove({type:b._id}):void 0},Meteor.startup(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;return i=DATA.findOne({name:"contact_button_list",type:"type"}),j=DATA.findOne({name:"initials_list",type:"type"}),k=DATA.findOne({name:"currency",type:"type"}),l=DATA.findOne({name:"countries_list",type:"type"}),m=DATA.findOne({name:"service",type:"type"}),n=DATA.findOne({name:"reach_type",type:"type"}),o=DATA.findOne({name:"humans",type:"type"}),0===DATA.find({type:o._id,aggregate:{$exists:!0}}).count()&&(console.log("here too"),d=DATA.find({type:o._id}),d.map(function(a){var b,c,d,e,f,g;return a.full_name.initials&&(d=DATA.findOne({_id:a.full_name.initials}),a.full_name.initials_name=d.name),g=[],e=0,f=!0,c=!0,traverse(a).map(function(){var a,b,d,h,i,j,k,l,m;if(5>=e){if("mobile"===this.path[0]&&"0"===this.key&&f===!0)return g[e]={key:"Call?",value:formatInternational(countryForE164Number(this.node),this.node),id:this.node},f=!1,e++,this.node;if("email"===this.path[0]&&"0"===this.key&&c===!0)return g[e]={key:"Email:",value:this.node,id:this.node,tip:"Hello there friend"},c=!1,e++,this.node;if("city"===this.key&&(i=DATA.findOne({_id:this.node})))return g[e]={key:"Staying at:",value:i.name,id:this.node},e++,this.node;if("service"===this.path[0]&&"0"===this.key&&(d=DATA.findOne({_id:this.node.currency}),j=DATA.findOne({_id:this.node.service}),d&&j))return a=DATA.findOne({name:"INR",type:d.type}),b=DATA.findOne({name:"THB",type:d.type}),m=(this.node.cost/d.usd_exchange_rate).toFixed(2),h=(this.node.cost/d.usd_exchange_rate*a.usd_exchange_rate).toFixed(2),k=(this.node.cost/d.usd_exchange_rate*b.usd_exchange_rate).toFixed(2),l="USD: "+m+"<br>THB: "+k+"<br>INR: "+h,g[e]={key:""+j.name+" for",value:""+this.node.cost+" "+d.name,id:this.node.cost,keyid:this.node.service,"class":"service_currency",curid:this.node.currency,tip:l},e++,this.node}}),b={imp:g},DATA.update({_id:a._id},{$set:{aggregate:b}})})),0===DATA.find().count()?(p=EJSON.parse(Assets.getText("types.json")),c=EJSON.parse(Assets.getText("countries.json")),a=EJSON.parse(Assets.getText("button_list.json")),e=EJSON.parse(Assets.getText("initials_list.json")),b=EJSON.parse(Assets.getText("cities.json")),f=[],_.map(p,function(a){return f[a.name]=DATA.insert(a),a}),_.map(c,function(a){var b;return b=a.type,a.type=f[b],DATA.insert(a)}),_.map(e,function(a){var b;return b=a.type,a.type=f[b],DATA.insert(a)}),_.map(a,function(a){var b,c;return b=a.type,a.type=f[b],a.select_database&&(c=a.select_database,a.select_database=f[c]),DATA.insert(a)}),_.map(b,function(a){var b,c,d;return b=a.type,c=a.country,d=DATA.findOne({name:c}),a.type=f[b],a.country_id=d._id,DATA.insert(a)}),console.log("Done")):0===DATA.find({type:i._id}).count()?(a=EJSON.parse(Assets.getText("button_list.json")),_.map(a,function(a){var b;return b=DATA.findOne({name:a.type}),a.type=b._id,_.map(a.input,function(a){var b;return a.select_database?(b=DATA.findOne({name:a.select_database}),a.select_database=b._id,void 0):(a.input_select_database&&(b=DATA.findOne({name:a.input_select_database}),a.input_select_database=b._id),void 0)}),DATA.insert(a)}),console.log("button lists inserted")):0===DATA.find({type:j._id}).count()?(e=EJSON.parse(Assets.getText("initials_list.json")),_.map(e,function(a){var b;return b=DATA.findOne({name:a.type}),a.type=b._id,DATA.insert(a)}),console.log("initials lists inserted")):0===DATA.find({type:m._id}).count()?(h=EJSON.parse(Assets.getText("service.json")),_.map(h,function(a){var b;return b=DATA.findOne({name:a.type}),a.type=b._id,DATA.insert(a)}),console.log("serivce lists inserted")):0===DATA.find({type:n._id}).count()?(g=EJSON.parse(Assets.getText("reach_type.json")),_.map(g,function(a){var b;return b=DATA.findOne({name:a.type}),a.type=b._id,DATA.insert(a)}),console.log("reach lists inserted")):void 0});